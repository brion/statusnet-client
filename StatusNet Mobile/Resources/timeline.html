<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Timeline</title>
<link rel="stylesheet" type="text/css" href="css/display.css">
</head>
<body>

<div id="notices">
<img class="spinner" src="images/loading.gif">
</div>

<script src="binding.js"></script><!-- hack for initialization bug on Android -->
<script src="lib/jquery-1.4.2.min.js"></script>
<script src="lib/humane.js"></script>
<script>
if (typeof Titanium == "undefined") {
    document.write('Titanium is undefined. Nothing will work in this webview.');
}

var activeNotice = null;

// App-wide event registration, whee!
Titanium.App.addEventListener("StatusNet_setTimeline", function(event) {
    activeNotice = null;
    $("#notices").html(event.html);
});
Titanium.App.addEventListener("StatusNet_appendTimelineNotice", function(event) {
    var notice;
    if (typeof event.notice == "string") {
        // On Android, objects get passed to us as JSON. Srsly?
        notice = eval('(' + event.notice + ')');
    } else {
        notice = event.notice;
    }
    /*
    Titanium.API.info('XXX: ' + typeof notice);
    if (typeof notice == "object") {
        for (var i in notice) {
            if (notice.hasOwnProperty(i)) {
                Titanium.API.info('XXX: notice.' + i + ': ' + typeof notice[i]);
            }
        }
    } else {
        Titanium.API.info('XXX: notice: ' + q);
    }
    */
    $("#notices").append(renderNotice(notice));
    enableNoticeControls(document.getElementById('notice-' + notice.id));
});

// Default handling for link click events; we'll pass external links on to the app
// for opening in a separate browser window.
$("#notices").delegate("a", "click", function(event) {
    if (this.href.substr(0, 4) == 'app:') {
        Titanium.API.info('Got a delegated click event for internal app link: ' + this.href);
    } else {
        Titanium.App.fireEvent("StatusNet_externalLink", {url: this.href});
        return false; // don't load the link in the webview.
    }
});

Titanium.App.fireEvent("StatusNet_timelineReady", {hey: "foo"});
Titanium.API.info("YAY - WebView is set up and waiting.");


/**
 * Put together the HTML for a single notice
 *
 * @param object notice the notice
 */
renderNotice = function(notice) {

    var html = [];
    var avatar = notice.avatar;
    var author = notice.author;
    var authorId = notice.authorId

    var classes = ['notice'];

    if (notice.favorite === "true") {
        classes.push('notice-favorite');
    }

    if (notice.repeated === "true") {
        classes.push('notice-repeated');
    }

    if (notice.repeat_of) {
        classes.push('notice-repeat');
    }

    html.push('<div class="' + classes.join(" ") + '" id="notice-' + notice.id +'" name="notice-' + notice.id +'">');
    html.push('<div class="avatar"><a href="' + notice.authorUri + '" rel="external"><img src="' + avatar + '"/></a>');
    html.push('</div>');
    html.push('<div>');
    html.push('<div class="date_link"><a href="' + notice.link + '" rel="external" title="View this notice in browser">' + humane_date(notice.updated) + '</a></div>');
    html.push('<a class="author" name="author-' + authorId + '" href="' + notice.authorUri + '" rel="external">' + author + '</a>');
    html.push('<div class="content">'+ notice.content +'</div>');
    html.push('</div>');

    html.push('<div class="notice_links">');
    html.push('<div class="links">');

    html.push('<div>');
    if (notice.source) {
        html.push('<div class="notice_source"><span class="notice_source_inner">from ' + notice.source + '</span></div>');
    }
    if (notice.contextLink && notice.inReplyToLink) {
        html.push(
            '<div class="context_link"><a rel="external" title="View this conversation in browser" href="'
            + notice.contextLink +'">in context</a></div>'
        );
    }
    html.push('</div>');

    html.push('<br>');
    html.push('<div>');
    html.push('<button class="notice_reply">Reply</button>');

    if (notice.favorite === "true") {
        html.push(' <button class="notice_unfave">Unfave</button>');
    } else {
        html.push(' <button class="notice_fave">Fave</button>')
    }

    /*if (author === this.client.account.username) {
        html.push(' <a href="#" class="notice_delete">Delete</a>')
    } else {*/
        if (notice.repeated === "false") {
            html.push(' <button class="notice_repeat">Repeat</button>');
        }
    //}

    html.push('<div>');
    html.push('</div></div></div>');
    html.push('<div class="clear"></div>');

    return html.join('');
}


enableNoticeControls = function(noticeDom) {
    var name = $(noticeDom).attr('name');
    var noticeId = name.substring(7); // notice-

    name = $(noticeDom).find('a.author').attr('name');
    var authorId = name.substring(7); // author-

    var noticeAuthor = $(noticeDom).find('a.author').text();

    Titanium.API.debug("authorId = " + authorId + " author name = " + noticeAuthor + " noticeId = " + noticeId);

    var uri = $(noticeDom).find('div a.author').attr('href');

    // Override links to external web view of the notice timelines
    // with click event handlers to display timelines within the client
    //if (this.localAuthor(uri)) {

        $(noticeDom).find('div a.author').attr('href', "#");
        $(noticeDom).find('div a.author').bind('click', function(event) {
            Titanium.App.fireEvent("StatusNet_switchUserTimeline", {authorId: authorId});
            return false;
        });

        $(noticeDom).find('div.avatar a').attr('href', "#");
        $(noticeDom).find('div.avatar').bind('click', function(event) {
            Titanium.App.fireEvent("StatusNet_switchUserTimeline", {authorId: authorId});
            return false;
        });
    //}

    $(noticeDom).find('button.notice_reply').bind('click', function(event) {
        Titanium.App.fireEvent("StatusNet_replyToNotice", {noticeId: noticeId, noticeAuthor: noticeAuthor});
        return false;
    });

    $(noticeDom).find('button.notice_fave').bind('click', function(event) {
        Titanium.App.fireEvent("StatusNet_faveNotice", {noticeId: noticeId});
        return false;
    });

    $(noticeDom).find('button.notice_unfave').bind('click', function(event) {
        Titanium.App.fireEvent("StatusNet_unfaveNotice", {noticeId: noticeId});
        return false;
    });

    $(noticeDom).find('button.notice_repeat').bind('click', function(event) {
        Titanium.App.fireEvent("StatusNet_repeatNotice", {noticeId: noticeId});
        return false;
    });

    $(noticeDom).find('button.notice_delete').bind('click', function(event) {
        Titanium.App.fireEvent("StatusNet_deleteNotice", {noticeId: noticeId});
        return false;
    });

    // Override external web links to local users in-content
    $(noticeDom).find('div.content span.vcard a').each(function() {
        var href = $(this).attr('href');
        //if (that.localAuthor(href)) {
            $(this).attr('href', '#');
            $(this).click(function() {
                var idRegexp = /(\d)+$/;
                result = href.match(idRegexp);
                if (result) {
                    Titanium.App.fireEvent("StatusNet_switchUserTimeline", {authorId: result[0]});
                    return false;
                }
            });
        //}
    });

    $(noticeDom).bind('click', function(event) {
        var speed = 200;
        if (activeNotice) {
            $(activeNotice).removeClass('foldout');
            $(activeNotice).find('.links').hide();
        }
        if (this === activeNotice) {
            activeNotice = null;
        } else {
            $(noticeDom).addClass('foldout');
            $(noticeDom).find('.links').show();
            activeNotice = noticeDom;
        }
    });

};
</script>
</html>